---
- name: Ensure curl is present (Linux)
  ansible.builtin.package:
    name: curl
    state: present
  become: true
  when:
    - mise_enabled
    - ansible_facts['os_family'] in ['Debian', 'RedHat']

- name: Check if mise is already installed
  ansible.builtin.command: mise --version
  register: mise_version
  changed_when: false
  failed_when: false
  when: mise_enabled

- name: Install mise (macOS via Homebrew)
  community.general.homebrew:
    name: mise
    state: present
  when:
    - mise_enabled
    - ansible_facts['os_family'] == 'Darwin'
    - mise_version.rc != 0

- name: Install mise (Linux via installer)
  ansible.builtin.shell: curl -fsSL https://mise.run | sh
  args:
    creates: "{{ ansible_facts['env']['HOME'] }}/.local/bin/mise"
  when:
    - mise_enabled
    - ansible_facts['os_family'] in ['Debian', 'RedHat']
    - mise_version.rc != 0

- name: Ensure mise is on PATH for bash (optional)
  ansible.builtin.blockinfile:
    path: "{{ ansible_facts['env']['HOME'] }}/.bashrc"
    create: true
    marker: "# {mark} ANSIBLE MANAGED - mise"
    block: |
      if [ -x "$HOME/.local/bin/mise" ]; then
        eval "$("$HOME/.local/bin/mise" activate bash)"
      fi
  when:
    - mise_enabled
    - mise_manage_shell

- name: Ensure mise is on PATH for zsh (optional)
  ansible.builtin.blockinfile:
    path: "{{ ansible_facts['env']['HOME'] }}/.zshrc"
    create: true
    marker: "# {mark} ANSIBLE MANAGED - mise"
    block: |
      if [ -x "$HOME/.local/bin/mise" ]; then
        eval "$("$HOME/.local/bin/mise" activate zsh)"
      fi
  when:
    - mise_enabled
    - mise_manage_shell
