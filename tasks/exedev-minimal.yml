---
# Minimal setup for exe.dev VMs
# Optimized for quick deployment and ephemeral environments

- name: Update APT cache
  ansible.builtin.apt:
    update_cache: yes
    cache_valid_time: 3600
  become: yes

- name: Install minimal essential packages
  ansible.builtin.apt:
    name: "{{ item }}"
    state: present
  become: yes
  loop: "{{ minimal_packages }}"

- name: Install minimal development tools
  ansible.builtin.apt:
    name: "{{ item }}"
    state: present
  become: yes
  loop: "{{ minimal_dev_tools }}"

- name: Install minimal shell tools
  ansible.builtin.apt:
    name: "{{ item }}"
    state: present
  become: yes
  loop: "{{ minimal_shell_tools }}"

- name: Install Starship prompt (minimal)
  ansible.builtin.shell: |
    curl -sS https://starship.rs/install.sh | sh -s -- -y
  args:
    creates: /usr/local/bin/starship

- name: Configure Starship in bashrc
  ansible.builtin.lineinfile:
    path: "{{ ansible_env.HOME }}/.bashrc"
    line: 'eval "$(starship init bash)"'
    create: yes

- name: Create minimal Starship config
  ansible.builtin.copy:
    dest: "{{ ansible_env.HOME }}/.config/starship.toml"
    content: |
      # Minimal Starship config for exe.dev VMs
      format = """
      [â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>](bold green)
      [â”‚](bold green)$directory$git_branch$git_status
      [â””â”€>](bold green) """

      [directory]
      truncation_length = 3
      truncate_to_repo = true

      [git_branch]
      symbol = "ğŸŒ± "
      format = "[$symbol$branch]($style) "

      [git_status]
      format = '([\[$all_status$ahead_behind\]]($style) )'
    mode: '0644'

- name: Link minimal dotfiles (vimrc) if available
  ansible.builtin.file:
    src: "{{ dotfiles_dest }}/.vimrc"
    dest: "{{ ansible_env.HOME }}/.vimrc"
    state: link
    force: yes
  when: dotfiles_dir.stat.exists
  ignore_errors: yes

- name: Link minimal dotfiles (tmux.conf) if available
  ansible.builtin.file:
    src: "{{ dotfiles_dest }}/.tmux.conf"
    dest: "{{ ansible_env.HOME }}/.tmux.conf"
    state: link
    force: yes
  when: dotfiles_dir.stat.exists
  ignore_errors: yes

- name: Create minimal bashrc additions
  ansible.builtin.blockinfile:
    path: "{{ ansible_env.HOME }}/.bashrc"
    marker: "# {mark} ANSIBLE MANAGED - exe.dev minimal setup"
    block: |
      # Aliases for modern tools
      alias ls='ls --color=auto'
      alias ll='ls -lah'
      alias grep='grep --color=auto'

      # If bat is available, use it instead of cat
      if command -v bat &> /dev/null; then
        alias cat='bat --paging=never'
      fi

      # If rg is available, use it instead of grep
      if command -v rg &> /dev/null; then
        alias grep='rg'
      fi

      # Git shortcuts
      alias g='git'
      alias gs='git status'
      alias ga='git add'
      alias gc='git commit'
      alias gp='git push'
      alias gl='git log --oneline --graph --decorate'

      # Quick directory navigation
      alias ..='cd ..'
      alias ...='cd ../..'
      alias ....='cd ../../..'

      # Safety nets
      alias rm='rm -i'
      alias cp='cp -i'
      alias mv='mv -i'

      # exe.dev specific
      export EXE_ENV=vm
    create: yes

- name: Set up minimal Git configuration
  community.general.git_config:
    name: "{{ item.name }}"
    scope: global
    value: "{{ item.value }}"
  loop:
    - { name: 'core.editor', value: 'vim' }
    - { name: 'core.autocrlf', value: 'input' }
    - { name: 'pull.rebase', value: 'false' }
    - { name: 'alias.co', value: 'checkout' }
    - { name: 'alias.br', value: 'branch' }
    - { name: 'alias.ci', value: 'commit' }
    - { name: 'alias.st', value: 'status' }

- name: Install fzf (minimal)
  ansible.builtin.git:
    repo: https://github.com/junegunn/fzf.git
    dest: "{{ ansible_env.HOME }}/.fzf"
    depth: 1
    update: yes

- name: Run fzf install script (bash only)
  ansible.builtin.shell: |
    "{{ ansible_env.HOME }}/.fzf/install" --key-bindings --completion --no-update-rc
  args:
    creates: "{{ ansible_env.HOME }}/.fzf.bash"

- name: Configure fzf in bashrc
  ansible.builtin.lineinfile:
    path: "{{ ansible_env.HOME }}/.bashrc"
    line: '[ -f ~/.fzf.bash ] && source ~/.fzf.bash'
    create: yes

- name: Display VM setup completion message
  ansible.builtin.debug:
    msg: |
      â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      âœ“ exe.dev VM minimal setup complete!

      Installed tools:
        â€¢ Modern CLI: bat, ripgrep, fzf, jq
        â€¢ Development: git, python3, nodejs
        â€¢ Shell: zsh with Starship prompt

      Quick start:
        1. Reload your shell: source ~/.bashrc
        2. Start coding!

      This is a minimal setup optimized for exe.dev VMs.
      For full desktop setup, use the linux or macos playbooks.
      â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
